## templateæ¨¡æ¿æ˜¯æ€æ ·é€šè¿‡Compileç¼–è¯‘çš„

### Compile

`compile`ç¼–è¯‘å¯ä»¥åˆ†æˆ`parse`ã€`optimize`ä¸`generate`ä¸‰ä¸ªé˜¶æ®µï¼Œæœ€ç»ˆå¾—åˆ°*render function*ã€‚

![compile](./02.png)

ğŸŒ°ï¼š

```html
<div :class="c" class="demo" v-if="isShow">
  <span v-for="item in sz">{{item}}</span>
</div>
```

```javascript
var html = '<div :class="c" class="demo" v-if="isShow"><span v-for="item in sz">{{item}}</span></div>';
```



#### 1. parse

`parse`ä¼šç”¨æ­£åˆ™ç­‰æ–¹å¼å°†templateæ¨¡æ¿è¿›è¡Œå­—ç¬¦ä¸²è§£æï¼Œå¾—åˆ°æŒ‡ä»¤ã€classã€styleç­‰æ•°æ®ï¼Œå½¢æˆ[AST](https://zh.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E8%AA%9E%E6%B3%95%E6%A8%B9)ï¼ˆæ­¤å¤„ç‰¹æŒ‡ç¼–ç¨‹è¯­è¨€çš„æºä»£ç ??ï¼‰ã€‚

ğŸŒ°æœ€ç»ˆå¾—åˆ°çš„ASTå¤§è‡´æ˜¯ä»¥ä¸‹æ ·å­ï¼š

```json
{
    /* æ ‡ç­¾å±æ€§çš„mapï¼Œè®°å½•äº†æ ‡ç­¾ä¸Šå±æ€§ */
    'attrsMap': {
        ':class': 'c',
        'class': 'demo',
        'v-if': 'isShow'
    },
    /* è§£æå¾—åˆ°çš„:class */
    'classBinding': 'c',
    /* æ ‡ç­¾å±æ€§v-if */
    'if': 'isShow',
    /* v-ifçš„æ¡ä»¶ */
    'ifConditions': [
        {
            'exp': 'isShow'
        }
    ],
    /* æ ‡ç­¾å±æ€§class */
    'staticClass': 'demo',
    /* æ ‡ç­¾çš„tag */
    'tag': 'div',
    /* å­æ ‡ç­¾æ•°ç»„ */
    'children': [
        {
            'attrsMap': {
                'v-for': "item in sz"
            },
            /* forå¾ªç¯çš„å‚æ•° */
            'alias': "item",
            /* forå¾ªç¯çš„å¯¹è±¡ */
            'for': 'sz',
            /* forå¾ªç¯æ˜¯å¦å·²ç»è¢«å¤„ç†çš„æ ‡è®°ä½ */
            'forProcessed': true,
            'tag': 'span',
            'children': [
                {
                    /* è¡¨è¾¾å¼ï¼Œ_sæ˜¯ä¸€ä¸ªè½¬å­—ç¬¦ä¸²çš„å‡½æ•° */
                    'expression': '_s(item)',
                    'text': '{{item}}'
                }
            ]
        }
    ]
}
```

èƒ½å¤Ÿæ¯”è¾ƒæ¸…æ™°åœ°æè¿°å‡ºæ ‡ç­¾çš„å±æ€§ä»¥åŠä¾èµ–å…³ç³»ã€‚

**æ­£åˆ™ï¼š**

ç”¨äºåŒ¹é…æ ‡ç­¾åã€æ ‡ç­¾å±æ€§ã€æ ‡ç­¾èµ·å§‹ã€æ ‡ç­¾é—­åˆã€é—­åˆæ ‡ç­¾ã€v-foræ¡ä»¶ã€æ–‡æœ¬èŠ‚ç‚¹å˜é‡ç­‰ã€‚

**function advance (n)**

å› ä¸ºè§£ætemplateé‡‡ç”¨*å¾ªç¯è¿›è¡Œå­—ç¬¦ä¸²åŒ¹é…*çš„æ–¹å¼ï¼Œæ‰€ä»¥æ¯åŒ¹é…è§£æå®Œä¸€æ®µæˆ‘ä»¬éœ€è¦å°†å·²ç»åŒ¹é…æ‰çš„å»æ‰ï¼Œå¤´éƒ¨çš„æŒ‡é’ˆæŒ‡å‘æ¥ä¸‹æ¥éœ€è¦åŒ¹é…çš„éƒ¨åˆ†ã€‚

**function parseHTML ()**

å¾ªç¯è§£ætemplateå­—ç¬¦ä¸²ã€‚ä½¿ç”¨`while`å¾ªç¯ï¼Œç”¨æ­£åˆ™åœ¨åŒ¹é…åˆ°æ ‡ç­¾å¤´ã€æ ‡ç­¾å°¾ä»¥åŠæ–‡æœ¬çš„æ—¶å€™åˆ†åˆ«è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œç›´åˆ°æ•´ä¸ªtemplateè¢«è§£æå®Œæ¯•ã€‚

**function parseStartTag ()**

ä½¿ç”¨`startTagOpen`æ­£åˆ™å¾—åˆ°æ ‡ç­¾çš„å¤´éƒ¨ï¼Œå¯ä»¥å¾—åˆ°`tagName`ï¼ŒåŒæ—¶æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°ç»„`attrs`ç”¨æ¥å­˜æ”¾æ ‡ç­¾å†…çš„å±æ€§ã€‚

æ¥ä¸‹æ¥ä½¿ç”¨`startTagClose`ä¸`attribute`ä¸¤ä¸ªæ­£åˆ™åˆ†åˆ«ç”¨æ¥è§£ææ ‡ç­¾ç»“æŸä»¥åŠæ ‡ç­¾å†…çš„å±æ€§ã€‚ä½¿ç”¨`while`å¾ªç¯ä¸€ç›´åˆ°åŒ¹é…åˆ°`startTagClose`ä¸ºæ­¢ï¼Œè§£æå†…éƒ¨æ‰€æœ‰çš„å±æ€§ã€‚

**stack:**

è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç»´æŠ¤ä¸€ä¸ª**stack**æ ˆæ¥ä¿å­˜å·²ç»è§£æå¥½çš„æ ‡ç­¾å¤´ï¼Œè¿™æ ·å¯ä»¥åœ¨è§£æå°¾éƒ¨æ ‡ç­¾çš„æ—¶å€™å¾—åˆ°æ‰€å±çš„å±‚çº§å…³ç³»ä»¥åŠçˆ¶æ ‡ç­¾ã€‚åŒæ—¶å®šä¹‰ä¸€ä¸ª**currentParent**å˜é‡ç”¨æ¥å­˜æ”¾å½“å‰æ ‡ç­¾çš„çˆ¶æ ‡ç­¾èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œ`root`å˜é‡ç”¨æ¥æŒ‡å‘æ ¹æ ‡ç­¾èŠ‚ç‚¹ã€‚

å°†parseStartTag()è¿”å›çš„ç»“æœå°è£…æˆ**element**ï¼ˆå³æœ€ç»ˆå½¢æˆçš„ASTçš„èŠ‚ç‚¹ï¼‰

**function parseEndTag (tagName)**

ç”¨äºè§£æå°¾æ ‡ç­¾ã€‚ä¼šä»stackæ ˆä¸­å–å‡ºæœ€è¿‘çš„è·Ÿè‡ªå·±æ ‡ç­¾åä¸€è‡´çš„é‚£ä¸ªå…ƒç´ ï¼Œå°†`currentParent`æŒ‡å‘é‚£ä¸ªå…ƒç´ çš„å‰ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶å°†è¯¥å…ƒç´ ä¹‹å‰çš„å…ƒç´ éƒ½ä»stackä¸­å‡ºæ ˆã€‚

**function parseText (text)**

è§£ææ–‡æœ¬æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯æ™®é€šçš„æ–‡æœ¬ï¼Œç›´æ¥æ„å»ºä¸€ä¸ªèŠ‚ç‚¹pushè¿›å½“å‰`currentParet`çš„`children`ä¸­å³å¯ï¼›å¦ä¸€ç§æ˜¯å½¢å¦‚"{{item}}"è¿™æ ·çš„Vuejsè¡¨è¾¾å¼ï¼Œéœ€è¦ç”¨parseTextæ¥å°†è¡¨è¾¾å¼è½¬åŒ–æˆä»£ç ã€‚

ä½¿ç”¨ä¸€ä¸ª`tokens`æ•°ç»„æ¥å­˜æ”¾è§£æç»“æœï¼Œé€šè¿‡`defaultTagRE`æ¥å¾ªç¯åŒ¹é…textï¼Œå¦‚æœæ˜¯æ™®é€šæ–‡æœ¬ç›´æ¥pushåˆ°`tokens`æ•°ç»„ä¸­ï¼Œå¦‚æœæ˜¯è¡¨è¾¾å¼ï¼Œåˆ™è½¬åŒ–æˆâ€œ_s(${exp})â€çš„å½¢å¼ã€‚

**function processIf (el) & function processFor (el)**

ç”¨äºå¤„ç†`v-if`ä»¥åŠ`v-for`è¿™æ ·çš„Vuejsè¡¨è¾¾å¼

â€œv-for"ä¼šå°†æŒ‡ä»¤è§£ææˆ`for`å±æ€§ä»¥åŠ`alias`å±æ€§ï¼Œè€Œâ€v-ifâ€œä¼šå°†æ¡ä»¶éƒ½å­˜å…¥`ifConditions`æ•°ç»„ä¸­ã€‚

```javascript
function parse () {
  parseHTML();
}
```



#### 2. optimize

ä¸»è¦ä½œç”¨ï¼šä¼˜åŒ–

æ¶‰åŠåˆ°`patch`è¿‡ç¨‹ï¼Œå› ä¸º`patch`çš„è¿‡ç¨‹å®é™…ä¸Šæ˜¯å°†VNodeèŠ‚ç‚¹è¿›è¡Œä¸€å±‚ä¸€å±‚çš„æ¯”å¯¹ï¼Œç„¶åå°†ã€Œå·®å¼‚ã€æ›´æ–°åˆ°è§†å›¾ä¸Šã€‚é‚£ä¹ˆä¸€äº›é™æ€èŠ‚ç‚¹æ˜¯ä¸ä¼šæ ¹æ®æ•°æ®å˜åŒ–è€Œäº§ç”Ÿå˜åŒ–çš„ï¼Œè¿™äº›èŠ‚ç‚¹æˆ‘ä»¬æ²¡æœ‰æ¯”å¯¹çš„éœ€æ±‚ => è·³è¿‡ä»¥èŠ‚çœä¸€äº›æ€§èƒ½ã€‚

æ ‡è®°`static`å±æ€§

**function isStatic (node)**

åˆ¤æ–­ä¸€ä¸ªnodeæ˜¯å¦æ˜¯é™æ€èŠ‚ç‚¹ã€‚å¦‚æœtypeä¸º2ï¼ˆè¡¨è¾¾å¼èŠ‚ç‚¹ï¼‰åˆ™æ˜¯éé™æ€èŠ‚ç‚¹ï¼Œtypeä¸º3ï¼ˆæ–‡æœ¬èŠ‚ç‚¹ï¼‰åˆ™æ˜¯é™æ€èŠ‚ç‚¹ï¼Œå¦‚æœå­˜åœ¨`if`æˆ–è€…`for`è¿™æ ·çš„æ¡ä»¶ï¼Œä¹Ÿæ˜¯éé™æ€èŠ‚ç‚¹

**function markStatic (node)**

ä¸ºæ‰€æœ‰çš„èŠ‚ç‚¹æ ‡è®°ä¸Š`static`å±æ€§ï¼ŒåŒæ—¶ä¼šéå†å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œå¦‚æœå­˜åœ¨å­èŠ‚ç‚¹æ˜¯éé™æ€èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå½“å‰èŠ‚ç‚¹ä¹Ÿæ˜¯éé™æ€èŠ‚ç‚¹ã€‚

**function markStaticRoots (node)**

ç”¨äºæ ‡è®°`staticRoot`ï¼ˆé™æ€æ ¹ï¼‰

å½“å‰èŠ‚ç‚¹æ˜¯é™æ€èŠ‚ç‚¹ï¼Œä¸”å­˜åœ¨å­èŠ‚ç‚¹ï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹æ—¶è¿™ä¸ªå­èŠ‚ç‚¹ä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼ˆä½œè€…è®¤ä¸ºæ­¤ç§æƒ…å†µçš„ä¼˜åŒ–æ¶ˆè€—å¤§äºæ”¶ç›Šï¼‰ï¼Œæ ‡è®°`staticRoot`ä¸ºtrueï¼Œå¦åˆ™ä¸ºfalseã€‚

```javascript
function optimize (rootAst) {
  markStatic( rootAst );
  martStaticRoots( rootAst );
}
```



#### 3.generate

å°†ASTè½¬åŒ–æˆ*render function*å­—ç¬¦ä¸²ï¼Œæœ€ç»ˆå¾—åˆ°renderçš„å­—ç¬¦ä¸²ä»¥åŠstaticRenderFnså­—ç¬¦ä¸²ã€‚

å¾—åˆ°çš„ç¼–è¯‘ç»“æœå¤§ä½“æ˜¯ä»¥ä¸‹æ ·å­ï¼š

```javascript
with(this){
    return (isShow) ? 
    _c(
        'div',
        {
            staticClass: "demo",
            class: c
        },
        _l(
            (sz),
            function(item){
                return _c('span',[_v(_s(item))])
            }
        )
    )
    : _e()
}
```

**function genIf (el)**

ç”¨äºå¤„ç†`if`æ¡ä»¶

**function genFor (el)**

ç”¨äºå¤„ç†`for`å¾ªç¯

**function genText (el)**

ç”¨äºå¤„ç†æ–‡æœ¬èŠ‚ç‚¹

**function genElement (el)**

ä¸€ä¸ªå¤„ç†èŠ‚ç‚¹çš„å‡½æ•°ã€‚ä¾èµ–`genChildren`ä»¥åŠ`genNode`å‡½æ•°

æ ¹æ®å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰`if`æˆ–è€…`for`æ ‡è®°åˆ¤æ–­æ˜¯å¦è¦ç”¨`genIf`æˆ–è€…`genFor`å¤„ç†ï¼Œå¦åˆ™é€šè¿‡`genChildren`å¤„ç†å­èŠ‚ç‚¹ï¼ŒåŒæ—¶å¾—åˆ°`staticClass`ã€`class`ç­‰å±æ€§ã€‚

`genChildren`ï¼Œéå†æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œé€šè¿‡`genNode`å¤„ç†åç”¨â€,"éš”å¼€æ‹¼æ¥æˆå­—ç¬¦ä¸²ã€‚

`genNode`ï¼Œæ ¹æ®`type`æ¥åˆ¤æ–­è¯¥èŠ‚ç‚¹ä½¿ç”¨æ–‡æœ¬èŠ‚ç‚¹`genText`è¿˜æ˜¯æ ‡ç­¾èŠ‚ç‚¹`genElement`æ¥å¤„ç†ã€‚

```javascript
// åˆ¤æ–­æ•´ä¸ªASTæ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™è¿”å›ä¸€ä¸ªdivæ ‡ç­¾ï¼Œå¦åˆ™é€šè¿‡`genElement`æ¥å¤„ç†
function generate (rootAst) {
  const code = rootAst ? genElement( rootAst ) : '_c("div")';
  return {
    render: `with(this){return ${code}}`,
  }
}
```

å¾—åˆ°çš„ç»“æœï¼š

```javascript
{
  render: `with(this){return (isShow)?_c('div,'{staticClass: demo,class: c,},_l((sz),function(item){return _c('span,'{staticClass: undefined,class: undefined,},_v("hello, "+_s(item)+".")}): _e()`
}
```



