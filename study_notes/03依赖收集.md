## å“åº”å¼ç³»ç»Ÿçš„ä¾èµ–æ”¶é›†è¿½è¸ªåŸç†



### ä¸ºä»€ä¹ˆæ”¶é›†ä¾èµ–ï¼Ÿ

ğŸŒ°ï¼šï¼ˆæé«˜æ€§èƒ½ï¼‰

```javascript
new Vue( {
  template: 
  	`<div>
				<span>{{text1}}</span>
				<span>{{text2}}</span>
		</div>`,
  	data: {
      text1: 'text1',
      text2: 'text2',
      text3: 'text3',
    }
} );
// æ‰§è¡Œå¦‚ä¸‹æ“ä½œ
this.text3 = 'modify text3';
```

æˆ‘ä»¬ä¿®æ”¹äº†`data`ä¸­çš„`text3`çš„æ•°æ®ï¼Œä½†æ˜¯è§†å›¾ä¸­å¹¶ä¸éœ€è¦ç”¨åˆ°`text3`ï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦è§¦å‘ä¸Šä¸€èŠ‚çš„`cb`å‡½æ•°æ¥æ›´æ–°è§†å›¾ï¼Œè°ƒç”¨`cb`æ˜¾ç„¶ä¸æ­£ç¡®ã€‚

å†ä¸€ä¸ªğŸŒ°ï¼š

```javascript
let globalObj = {
  text1: 'text1'
};

let o1 = new Vue( {
  template: 
  	`<div>
			<span>{{text1}}</span>
		</div>`,
  data: globalObj
} );

let o2 = new Vue( {
  template: 
  	`<div>
			<span>{{text1}}</span>
		</div>`,
  data: globalObj
} );
// æ‰§è¡Œå¦‚ä¸‹æ“ä½œ
globalObj.text1 = 'hello, text1';
```

æ­¤æ—¶åº”é€šçŸ¥`o1`ä»¥åŠ`o2`ä¸¤ä¸ªvmå®ä¾‹è¿›è¡Œè§†å›¾çš„æ›´æ–°ã€‚**ä¾èµ–æ”¶é›†**è®©`text1`çŸ¥é“æœ‰ä¸¤ä¸ªåœ°æ–¹ä¾èµ–ä»–çš„æ•°æ®ï¼Œå˜åŒ–æ—¶éœ€è¦é€šçŸ¥å®ƒä»¬ã€‚

![collect.png](./collect.png)

æœ€ç»ˆå½¢æˆæ•°æ®ä¸è§†å›¾çš„ä¸€ç§å¯¹åº”å…³ç³»ã€‚



### å¦‚ä½•å®ç°ã€Œä¾èµ–æ”¶é›†ã€

#### * è®¢é˜…è€…Dep

ä¸»è¦ç”¨äºå­˜æ”¾`Watcher`è§‚å¯Ÿè€…å¯¹è±¡ï¼ˆç»´æŠ¤Watcheré›†åˆï¼‰

```javascript
class Dep {
  contructor () {
    // ...
  }
  
  addSub (sub) {
    // ...
  }
  
  notify () {
    // ...
  }
}
```

ä¸»è¦åšä¸¤ä»¶äº‹æƒ…ï¼š

1. `addSub`æ–¹æ³•å¯ä»¥åœ¨å½“å‰`Dep`å¯¹è±¡ä¸­å¢åŠ ä¸€ä¸ª`Watcher`å¯¹è±¡çš„**è®¢é˜…æ“ä½œ**ï¼›
2. ä½¿ç”¨`notify`æ–¹æ³•é€šçŸ¥å½“å‰`Dep`å¯¹è±¡çš„`subs`ä¸­çš„æ‰€æœ‰`Watcher`å¯¹è±¡è§¦å‘æ›´æ–°æ“ä½œã€‚

#### * è§‚å¯Ÿè€…Watcher

```javascript
class Watcher {
  constructor () {
    // ...
  }
  
  update () {
    // ...
  }
}
Dep.target = null;
```

#### * ä¾èµ–æ”¶é›†

ä¿®æ”¹ä¸€ä¸‹`defineReactive`ä»¥åŠ`Vue`çš„æ„é€ å‡½æ•°ï¼Œæ¥å®Œæˆä¾èµ–æ”¶é›†ã€‚

* åœ¨æ„é€ å‡½æ•°ä¸­ æ”¾ä¸€ä¸ªWatcherå®ä¾‹ã€‚

1. åœ¨`defineReactive`ä¸­å¢åŠ ä¸€ä¸ªDepç±»çš„å¯¹è±¡ï¼Œç”¨äºæ”¶é›†`Watcher`å¯¹è±¡ã€‚
2. åœ¨å¯¹è±¡çš„å±æ€§è¢«**è¯»**çš„æ—¶å€™ï¼Œä¼šè§¦å‘`reactiveGetter`å‡½æ•°ï¼ŒæŠŠå½“å‰çš„`Watcher`å¯¹è±¡ï¼ˆä¸´æ—¶å­˜æ”¾åœ¨Dep.targertä¸­ï¼‰æ”¶é›†åˆ°`Dep`å¯¹è±¡ä¸­ã€‚
3. ä¹‹åå½“è¯¥å±æ€§è¢«**å†™**çš„æ—¶å€™ï¼Œä¼šè§¦å‘`reactiveSetter`å‡½æ•°ï¼Œé€šçŸ¥`Dep`å¯¹è±¡è°ƒç”¨`notify`æ¥è§¦å‘æ‰€æœ‰`Watcher`å¯¹è±¡çš„`update`æ–¹æ³•æ¥æ›´æ–°å¯¹åº”è§†å›¾ã€‚



### å°ç»“

é¦–å…ˆåœ¨`observe`çš„è¿‡ç¨‹ä¸­ä¼šæ³¨å†Œ`get`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºã€Œ**ä¾èµ–æ”¶é›†**ã€ã€‚

> åœ¨getçš„é—­åŒ…ä¸­æ”¾ä¸€ä¸ª`Dep`å¯¹è±¡ï¼Œç”¨äºå­˜æ”¾`Watcher`å¯¹è±¡å®ä¾‹ã€‚
>
> ã€Œä¾èµ–æ”¶é›†ã€çš„è¿‡ç¨‹å°±æ˜¯æŠŠ`Watcher`å®ä¾‹å­˜æ”¾åˆ°å¯¹åº”çš„`Dep`å¯¹è±¡ä¸­å»ã€‚

é™¤æ­¤ä»¥å¤–ï¼Œä¾èµ–æ”¶é›†çš„å‰ææ¡ä»¶è¿˜æœ‰ä¸¤ä¸ªï¼š

1. è§¦å‘`get`æ–¹æ³•
2. æ–°å»ºä¸€ä¸ª`Watcher`å¯¹è±¡

> åœ¨ä¾‹å­ä¸­ï¼Œåœ¨Vueçš„æ„é€ å‡½æ•°ä¸­æ–°å»ºäº†ä¸€ä¸ª`Watcher`å¯¹è±¡ï¼ˆç”¨äºç»„ä»¶æ¸²æŸ“ï¼Ÿï¼‰ï¼Œåªéœ€è¦newå‡ºæ¥ï¼Œæ­¤æ—¶`Dep.target`å·²ç»æŒ‡å‘äº†è¿™ä¸ªnewå‡ºæ¥çš„`Watcher`å¯¹è±¡ã€‚
>
> è€Œè§¦å‘`get`ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦æŠŠrender functionè¿›è¡Œæ¸²æŸ“ï¼Œé‚£ä¹ˆå…¶ä¸­çš„ä¾èµ–éƒ½ä¼šè¢«è¯»å–ï¼Œæ­¤ä¾‹ä¸­é€šè¿‡æ‰“å°æ¥æ¨¡æ‹Ÿè¿™ä¸ªè¯»å–ï¼Œæ¥è§¦å‘`get`è¿›è¡Œ**ä¾èµ–æ”¶é›†**

`get`è¿›è¡Œã€Œä¾èµ–æ”¶é›†ã€ï¼Œ`set`é€šè¿‡è§‚å¯Ÿè€…æ¥æ›´æ–°è§†å›¾

![03.png](./03.png)





ã€Œè¡¥å……ã€ï¼š

ä¸€ä¸ªå¯¹è±¡å±æ€§å¯¹åº”ä¸€ä¸ªdepï¼Œä¸€ä¸ªdepå¯¹åº”å¤šä¸ªwatcherï¼ˆä¸€ä¸ªå¯¹è±¡å±æ€§å¯èƒ½åœ¨å¤šä¸ªæ ‡ç­¾ä½¿ç”¨ï¼Œå°±ä¼šæœ‰å¯¹åº”å¤šä¸ªwatcherï¼Œè¿™äº›watcheréƒ½ä¼šæ”¾å…¥åˆ°è¿™ä¸ªå¯¹è±¡å±æ€§å”¯ä¸€å¯¹åº”çš„depä¸­ï¼‰=> è¿™æ˜¯**Vue1.0**çš„å®ç° => å½“æ•°æ®è¿‡å¤§ä¼šå¯¼è‡´watcheræ•°é‡è¿‡å¤šè¿›è€Œå½±å“æ€§èƒ½

**Vue2.0**ä¸­å¼•å…¥VDOMï¼Œç»™æ¯ä¸ªvueç»„ä»¶ç»‘å®šä¸€ä¸ªwatcherï¼Œè¿™ä¸ªç»„ä»¶ä¸Šçš„æ•°æ®çš„depä¸­éƒ½åŒ…å«æœ‰è¯¥watcher => æ–°æ—§VDOMå¯¹æ¯”ï¼Œæå¤§å‡å°‘watcheræ•°é‡

æ¯newä¸€ä¸ªwatcherå°±è§¦å‘ä¸€æ¬¡è¯¥å±æ€§çš„getteræ“ä½œï¼ˆï¼Ÿï¼‰ï¼ˆä¸è¯¥watcherç›¸å…³çš„å±æ€§ï¼‰



å¯¹äºä¾‹å­ï¼Œå®ä¾‹åŒ–äº†ä¸¤æ¬¡Vueï¼Œå¯¹globalObjæ‰§è¡Œäº†ä¸¤éobserverï¼Œdepå˜äº†ï¼ˆï¼Ÿï¼‰ï¼Œç¬¬ä¸€æ¬¡çš„depæ”¶é›†çš„watcheræ²¡äº†ï¼ˆï¼Ÿï¼‰



Vuexï¼šå…¨å±€store -> å¤šä¸ªè§†å›¾

ç»„ä»¶ï¼šå…¨å±€æ¸²æŸ“Watcher-> å¤šä¸ªdataå±æ€§

æŸä¸€å±æ€§ï¼ˆå¯¹åº”å”¯ä¸€depï¼‰->å¤šä¸ªè§†å›¾ï¼ˆçš„æ¸²æŸ“Watcherï¼‰

